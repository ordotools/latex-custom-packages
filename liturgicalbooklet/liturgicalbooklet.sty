\ProvidesPackage{liturgicalbooklet}

%\semiisopage[8]
%\checkandfixthelayout

\settypeblocksize{7in}{3.8in}{*}
\setlrmargins{.6in}{*}{*}
\setulmargins{.6in}{*}{*}
\checkandfixthelayout

%\title{Maundy Thursday}
%\author{Rev. Gregory R. Barnes}
% TODO: make this a function for a generic title
\pretitle{
    \begin{center}
	\scshape The Office of Tenebr\ae\ of\linebreak\vspace{.125in}
	\normalfont\Huge
    }
    % the title is defined in each main file
\posttitle{\end{center}}
\preauthor{
    \vfill
    \begin{center}\small
    \textit{Property of}\\
    % TODO: I want this to be swashed eventually
}
    \author{Queen of All Saints Chapel}
\postauthor{
    \end{center}
}
\date{} % the date is no use in this context

%\RequirePackage{showframe}

%%% GREGORIOTEX %%%
\RequirePackage[autocompile]{gregoriotex}
\gresetlinecolor{gregoriocolor}
\gresetinitiallines{1}
\gresetannotationvalign{bottom}
\grechangestyle{modeline}{\small} \grechangestyle{annotation}{\small}
\gresetgregpath{{./antiphons/}}
\gresetgregpath{{./responsories/}}

\RequirePackage{psalms} % Custom... nice

\RequirePackage{ifthen}
\RequirePackage[super]{nth}
\RequirePackage[latin]{babel}
\RequirePackage{fontspec}
% \RequirePackage[T1]{fontenc}
\defaultfontfeatures{Ligatures=TeX,RawFeature={+onum}}
\setmainfont{Minion 3}[
  SizeFeatures = {
    {Size={-9.2},  OpticalSize=Caption},   % small, sturdy
    {Size={9.2-12}, OpticalSize=Regular},
    {Size={12-17},  OpticalSize=Subhead},
    {Size={17-},    OpticalSize=Display}
  },
  Numbers = {OldStyle,Proportional},
  StylisticSet = {1},
]

% must be after gregoriotex -- for the final run
\RequirePackage[protrusion=true,expansion=true,tracking=true]{microtype}
\microtypecontext{spacing=nonfrench} % liturgical punctuation benefits
% Slight letterspacing for small caps and rubrics:
\SetTracking{encoding=*, shape=sc}{40} % 40 = ~0.04em, tasteful
\SetProtrusion
  [ name=minion3,
    load = default ]
  { encoding = *, family = * }
  {
    % gentle opening quotes / punctuation hang; improves verticals
    \textquotedblleft = {100, 100},
    \textquoteleft    = {100,  60},
    \textemdash       = { 50,  50},
    \textendash       = { 50,  50},
    .                 = { 40,  60},
    ,                 = { 50,  50},
    ;                 = { 30,  40},
    :                 = { 30,  40}
  }
% \UseMicrotypeSet[minion3]{protrusion}

% page numbering
\newcommand{\pagenumstyle}{\addfontfeatures{Numbers={Lining,Monospaced}}}
\makeevenfoot{plain}{}{\pagenumstyle\thepage}{}
\makeoddfoot {plain}{}{\pagenumstyle\thepage}{}
% tighten lines before a page break
\looseness=-1 % judiciously on paragraphs before bad breaks

% paragraph economy
\clubpenalty=10000
\widowpenalty=10000
\displaywidowpenalty=10000


\RequirePackage{lettrine}

\RequirePackage{titlesec}

\RequirePackage{import}

% TODO: make this our own custom heading
\chapterstyle{southall}

\titleformat{\subsection}
{\centering\small\color{red}}{\thesection}{0.5em}{}

\newcommand{\red}[1]{\textcolor{red}{#1}}
\newcommand{\black}[1]{\textcolor{black}{#1}}

\newcommand{\redtitle}[1]{
    \subsection*{#1}
	%\begin{center}
		%{\small\color{red}#1}
	%\end{center}
	}

\newcommand{\rubric}[1]{
	% \begin{raggedright}
		%\vspace{1em}
    \smallskip
    {\color{red}\footnotesize #1}
    \smallskip
	% \end{raggedright}
}

%-------------------------------------------------------------------%
% variable doxologies {this is very much a work in progress!!}
%-------------------------------------------------------------------%

% --- THIS IS THE FIRST ATTEMPT AND IT SEEMS TO WORK WELL
\makeatletter
% \AdaptiveFill{<short>}{<medium>}{<long>}
\newcommand{\AdaptiveFill}[3]{%
  % End the current paragraph so we’re in vertical mode and the page builder is active:
  \par
  \begingroup
  % Remaining vertical space on the current page/column:
  \dimen@=\dimexpr\pagegoal-\pagetotal\relax
  % If we're not on a normal page (e.g., inside a minipage/box), \pagegoal is \maxdimen.
  \ifdim\pagegoal=\maxdimen
    \noindent #3\par % default to the long version in boxes
  \else
    % Try LONG
    \setbox0=\vbox{\hsize=\linewidth \noindent #3\par}%
    \ifdim\ht0>\dimen@
      % Try MEDIUM
      \setbox0=\vbox{\hsize=\linewidth \noindent #2\par}%
      \ifdim\ht0>\dimen@
        % Fall back to SHORT
        \noindent #1\par
      \else
        \noindent #2\par
      \fi
    \else
      \noindent #3\par
    \fi
  \fi
  \endgroup
}
\makeatother

\newcommand{\doxShort}{Qui tecum vivit et regnat.}
\newcommand{\doxMed}{Qui tecum vivit et regnat in unitáte Spíritus Sancti.}
\newcommand{\doxLong}{Qui tecum vivit et regnat in unitáte Spíritus Sancti, Deus, per ómnia sǽcula sæculórum.}

%-------------------------------------------------------------------%
% Common commands
%-------------------------------------------------------------------%
% Applies lettrine to the first letter, rest printed inline.
\newcommand{\dropcap}[1]{%
  \lettrine[lines=2]{\MakeUppercase{#1}}{}%
}

% Variant that takes a full sentence/paragraph
\newcommand\orationsimple[1]{%
  \let\firstchar\relax
  \def\firstchar##1##2\relax{%
      \lettrine[lines=2]{\MakeUppercase{\color{red}##1}}{##2}%
  }%
  \firstchar#1\relax
}


\makeatletter
\newcommand{\oration}[1]{%
    \redtitle{Oratio.}
  % Split into first word (#1) and rest (#2)
  \def\split@first##1 ##2\@nil{%
    % Extract first token and the rest of that first word
    \edef\first@letter{\expandafter\@car##1\@nil}%
    \edef\rest@letters{\expandafter\@cdr##1\@nil}%
    % Drop cap: first letter uppercased, rest of word uppercased by LettrineTextFont
    \renewcommand{\LettrineTextFont}{\MakeUppercase}%
    \lettrine[lines=2]{\color{gregoriocolor}\MakeUppercase{\first@letter}}{\rest@letters}%
    % If there’s more text after the first word, typeset it
    \if\relax\detokenize{##2}\relax\else\ ##2\fi
  }%
  % Call the splitter; the added space ensures it always works
  \expandafter\split@first#1 \@nil
}
\makeatother





\newcounter{antiphon}\setcounter{antiphon}{1}
\newcounter{allantiphon}\setcounter{allantiphon}{1}
\newcounter{responsory}\setcounter{responsory}{1}
\newcounter{lesson}\setcounter{lesson}{1}


\newcommand{\buildpsalm}[3]{
	\ifnum \value{allantiphon}=10 {\setcounter{antiphon}{1}} \fi
	\gresetannotationvalign{bottom}
	\greannotation{Ant. \theantiphon}
	\gresetgregpath{{./antiphons/}}
	\greannotation{#3}
	\gregorioscore{#1}
	\subsection{Psalm #2.}
	\gresetinitiallines{0} % only the first antiphon has a dropcap
	\psalm[ng]{#2}{#3} % --> "ng" sets the psalm to have no gloria
	\stepcounter{antiphon}
	\stepcounter{allantiphon}
	\gresetinitiallines{1}
	}

\newcommand{\buildcanticlem}[1]{
	\ifnum \value{allantiphon}=10 {\setcounter{antiphon}{1}} \fi
	\greannotation{Ant. \theantiphon}
	\gresetgregpath{{./antiphons/}}
	\gresetannotationvalign{bottom}
	\gregorioscore{#1}
	\gresetinitiallines{0} % only the first antiphon has a dropcap
	\subsection{Canticle of Moses.}
	\gresetgregpath{{./canticles/}}
	\gregorioscore{canticle-moses}
	\import{./canticles/}{Canticum Moysis (Exod)-4A.tex}
	\stepcounter{antiphon}
	\stepcounter{allantiphon}
	\gresetinitiallines{1}
	}

\newcommand{\buildcanticleh}[1]{
	\ifnum \value{allantiphon}=10 {\setcounter{antiphon}{1}} \fi
	\greannotation{Ant. \theantiphon}
	\greannotation{1 f.}
	\gresetgregpath{{./antiphons/}}
	\gresetannotationvalign{bottom}
	\gregorioscore{#1}
	\gresetinitiallines{0} % only the first antiphon has a dropcap
	\subsection{Canticle of Habacuc.}
	\gresetgregpath{{./canticles/}}
	\gregorioscore{canticle-habacuc}
	\import{./canticles/}{habacuc.tex}
	\stepcounter{antiphon}
	\stepcounter{allantiphon}
	\gresetinitiallines{1}
	}

\newcommand{\buildcanticlee}[1]{
	\ifnum \value{allantiphon}=10 {\setcounter{antiphon}{1}} \fi
	\greannotation{Ant. \theantiphon}
	\greannotation{2 D.}
	\gresetgregpath{{./antiphons/}}
	\gresetannotationvalign{bottom}
	\gregorioscore{#1}
	\gresetinitiallines{0} % only the first antiphon has a dropcap
	\subsection{Canticle of Ezechias.}
	\gresetgregpath{{./canticles/}}
	\gregorioscore{ez}
	\import{./canticles/}{ez.tex}
	\stepcounter{antiphon}
	\stepcounter{allantiphon}
	\gresetinitiallines{1}
	}

\newcommand{\buildcanticlez}[1]{

    \rubric{During the singing of the \black{Benedictus,} the lights of the
    church are put out and the six candles on the altar are extinguished, one
    every second verse. During the repetition of the antiphon \black{Traditur,}
    the last candle is taken from the hearse and placed behind the altar at the
    Epistle side.}

	\gresetannotationvalign{bottom}
	\greannotation{At Bened.}
	\greannotation{Ant. 1.g}
	\gresetgregpath{{./antiphons/}}
	\gregorioscore{#1}
	\gresetinitiallines{0} % only the first antiphon has a dropcap
	\subsection{Canticle of Zachary.}
	\gresetgregpath{{./canticles/}}
	\gregorioscore{Benedictus-solemn1g}
	\import{./canticles/}{Benedictus-solemn1g.tex}
	\stepcounter{antiphon}
	\stepcounter{allantiphon}
	\gresetinitiallines{1}
	}

\newcommand\lesson{
    \subsection{Lesson \MakeUppercase{\romannumeral \thelesson.}}
    \stepcounter{lesson}
}

\newcommand\responsory[2]{
    \gresetgregpath{{./responsories/}}
    \greannotation{Resp. \theresponsory}
    \stepcounter{responsory}
    \greannotation{#2}
    \gregorioscore{#1}
    }

\newcommand\christus[1]{

    \rubric{The cantors intone the \black{Christus.}}

	\gresetinitiallines{1}
    \gresetgregpath{{./christus/}}
    \gregorioscore{christus-#1}


    \rubric{\black{Pater noster} in silence.}
    }

\newcommand{\versicle}[2]{
	\gresetinitiallines{0}
	\gabcsnippet{(c4) <c><sp>V/</sp>.</c> #1 (::)}
	\gabcsnippet{(c4) <c><sp>R/</sp>.</c> #2 (::)}
	\gresetinitiallines{1}
}

\setlength{\parindent}{0pt}
\gresetbracerendering{font}

\newcommand\respice{

    \subsection{Prayer}

    \rubric{Chanted in a low, grave, voice, with no other inflexion than the
    lowering of the voice a tone on the last syllable.}

    \lettrine[lraise=0.1,nindent=0em,slope=-0.5em]{R}{\'espice,} qu\'\ae sumus
    D\'omine, super hanc fam\'iliam tuam, pro qua D\'ominus noster Jesus
    Christus non dubit\'avit m\'anibus tradi noc\'entium, et crucis sub\'ire
    torm\'entum. \red{\small silently} Qui tecum vivit et regnat in unitáte
    Spíritus Sancti, Deus, per ómnia s\'\ae cula s\ae culórum. Amen.

    \rubric{At the end of this prayer, a noise is made by knocking the stalls of the choir until the lighted candle re-appears from behind the altar and is placed on the hearse. All then rise and retire in silence.}
}
